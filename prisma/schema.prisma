generator client {
  provider = "prisma-client"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}
// ============================================================================
// ENUMS
// ============================================================================
enum KycStatus {
  PENDING  
  VERIFIED  
  REJECTED  

}

enum UserStatus {
  ACTIVE    
  SUSPENDED 
  CLOSED    
}

enum RevocationReason {
  USER_LOGOUT  
  PASSWORD_CHANGE 
  FRAUD           
  IDLE_TIMEOUT    
  TOKEN_REUSE     
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id                String     @id @default(uuid())
  email             String     @unique
  phone             String?    @unique //nullable
  fullName          String     @map("full_name")
  kycStatus         KycStatus  @default(PENDING) @map("kyc_status")
  passwordHash      String     @map("password_hash")
  kycVerifiedAt     DateTime?  @map("kyc_verified_at")
  passwordChangedAt DateTime?  @map("password_changed_at")
  status            UserStatus @default(ACTIVE)
  sessions          Session[]
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  @@index([email])
  @@index([kycStatus])
  @@map("users")
}

model Session {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now()) @map("created_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")
  expiresAt      DateTime @map("expires_at")

  revoked          Boolean           @default(false)
  revokedAt        DateTime?         @map("revoked_at")
  revocationReason RevocationReason? @map("revocation_reason")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  refreshTokens RefreshToken[]

  @@index([userId, revoked])
  @@index([expiresAt])
  @@index([lastActivityAt])
  @@map("sessions")
}

model RefreshToken {
  id        String  @id @default(uuid())
  sessionId String  @map("session_id")
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  tokenHash   String    @unique @map("token_hash")
  tokenFamily String    @map("token_family")
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime  @map("expires_at")
  usedAt      DateTime? @map("used_at")

  parentTokenId String?        @map("parent_token_id")
  parentToken   RefreshToken?  @relation("TokenRotation", fields: [parentTokenId], references: [id], onDelete: SetNull)
  childTokens   RefreshToken[] @relation("TokenRotation")

  @@index([tokenHash])
  @@index([sessionId])
  @@index([tokenFamily])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Role {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("roles")
}
